var Q = require('q');

var proc = require('child_process');

module.exports = function (result, script) {


    console.log("Start Execute Function");
    console.log("Script = " + script);
  var def = Q.defer();

  if (!script) {
      console.log("Loic Path 1");
    def.resolve(result);
  } else if (script.shell) {              //Shell
      console.log("Loic Path 2");
    console.log('spawning shell');
    console.log(script);
    proc.exec(script.shell, function(error, stdout, stderr) {
        if (error) {
        console.log("Loic Path 3");
        console.log("exec error: " + error);
        //TODO: should this be rejecting the result?
        def.reject(result);
      }

        if (script.logOutput) {
        console.log("Loic Path 4");
        console.log("exec stdout: " + stdout);
        console.log("exec stderr: " + stderr);
      }
        console.log("Loic Path 5");
      def.resolve(result);
    });
  } else if (script.bashScript) {            // bashScript

      console.log("Loic Path 6");
      console.log("script.bashScript = " + script.bashScript);
      console.log("script.bashParams = " + script.bashParams);
    var child = proc.spawn(script.bashScript, script.bashParams);
    console.log('spawning script');
    console.log(script);
    child.stdout.on('data', function (data) {
        console.log("Loic Path 7");
        if (script.logOutput) {
            console.log("Loic Path 8");
        console.log("exec stdout: " + data);
      }
    });
    child.stderr.on('data', function (data) {
        console.log("Loic Path 10");
        if (script.logOutput) {
            console.log("Loic Path 11");
        console.log("exec stderr: " + data);
      }
    });
    child.on('exit', function (code) {
        console.log("Loic Path 12");
        if (code != 0) {
            console.log("Loic Path 13");
        def.reject(new Error('error running bash script'));
        } else {
            console.log("Loic Path 14");
        def.resolve(result)
      }
    });

  } else {                                                 //Nothing
      console.log("Loic Path 15");
    //odd to do this first and last.
    def.resolve(result);
  }
  console.log("Loic Path 16");
  return def.promise;
}
